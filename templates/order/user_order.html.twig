{% extends 'base.html.twig' %}

{% block title %}Order History{% endblock %}

{% block body %}
<br><br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

    <div class="container my-4">
        <h1 class="text-secondary mb-4">Order History</h1>

        {% if orders is empty %}
            <div class="alert alert-info">
                No orders found.
            </div>
        {% else %}
            {% for order in orders %}
                <div class="text-info mt-4 mb-3">
                    <div class="card-header bg-light">
                        <h5 class="card-title text-primary mb-0">
                            Order #{{ order.id }}
                        </h5>
                         <div class="actions">
                         <a href="{{ path('user_update_order', {'id': order.id}) }}" class="btn btn-sm btn-primary me-2">
                                <i class="fas fa-edit"></i> Update Delivery Info
                            </a>
                            <a href="{{ path('admin_delete_user_order', {'orderId': order.id, 'token': csrf_token('delete-user-order')}) }}" 
                               onclick="return confirm('Are you sure you want to delete this order?');" 
                               class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i> Delete
                            </a>
                        </div>
                    </div>
                    </div>
                    <div class="card-body">
                        <h5 class="text-info mt-4 mb-3">Delivery Information</h5>
                        <p><strong>Delivery Address:</strong> {{ order.deliveryAdress }}</p>
                        <p><strong>Phone Number:</strong> {{ order.phoneNumber }}</p>
                        <p><strong>Order Date:</strong> {{ order.DateOrder|date('d/m/Y') }}</p>
                    
                        {% if order.Cart %}
                            <h5 class="text-info mt-4 mb-3">Cart Information</h5>
                            <p><strong>Cart ID:</strong> {{ order.Cart.id }}</p>
                        {% endif %}
                        
                        {% if order.orderHistory %}
                            <h5 class="text-primary mt-4 mb-3">Order Details</h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>Product</th>
                                            <th>Price</th>
                                            <th>Quantity</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% set history = order.orderHistory|replace({'"': ''})|replace({'{': ''})|replace({'}': ''})|replace({'[': ''})|replace({']': ''}) %}
                                        {% for item in history|split(',') %}
                                            {% set itemData = item|split(':') %}
                                            {% if 'name' in itemData[0] %}
                                                <tr>
                                                    <td>{{ itemData[1] }}</td>
                                                    <td>{{ history|split('price:')[1]|split(',')[0] }} dt</td>
                                                    <td>{{ history|split('quantity:')[1]|split(',')[0] }}</td>
                                                </tr>
                                            {% endif %}
                                        {% endfor %}
                                        <tr class="bg-light">
                                            <td colspan="2"><strong class="text-secondary">Shipping Cost</strong></td>
                                            <td><strong class="text-secondary">10 dt</strong></td>
                                        </tr>
                                        <tr class="bg-info bg-opacity-10">
                                            <td colspan="2"><strong class="text-primary">Total Price</strong></td>
                                            <td><strong class="text-primary">{{ (history|split('totalPrice:')[1]|split(',')[0] + 10) }} dt</strong></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">No order history information available.</p>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    </div>
{% endblock %}